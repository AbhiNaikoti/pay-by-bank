# Implementation Guide

[//]: <> (This is where you will want to do a brief overview of ConnectPay and what it does to help clients at Fiserv)
Update here

# Information on Integration
while we know you have various ways to integrate, we are here to assist you in integrating with us here at Fiserv. If you have 
[//]: <> (You will want to step through the integration process. You will need to create paths that are common for any and all merchants. Where there are differences, we will want to fork them using sub steps with ### instead of the ## for category headings. But, it will be necessary to understand the actual process first.)

## Pre-requisites

### Connectivity
The ConnectPay services are accessed through the public Internet. ConnectPay accepts communication only via the HTTPS channel. Custom HTTP headers are also used carry additional information in each request.
|Environment                |Host                                     |Base Path  |
|---------------------------|-----------------------------------------|-----------|
|Certification API End Point|https://cat.api.firstdata.com/gateway/v2 |/connectpay|
|Production API End Point   |https://prod.api.firstdata.com/gateway/v2|/connectpay|

### Header Description
The header of Each API call will contain several parameters. It is important that each parameter contain the specified values to have a successful API Call. Any changes to the values will be noted through out the guide.

#### HTTP Headers
|Header Name  |Required   |Description|
|-------------|-----------|-----------|
|Api-Key      |Yes        |This is the partner API key. Refer to the Apigee portal for more details. This is the API key is used to identify the partner and to use the ConnectPay API.|
|Timestamp    |Yes        |Request initiation UTC timestamp, formatted as Epoch time. The value is in milliseconds. Sample value format is 1499961987232|
|Authorization|Optional   |Authorization header is required to have the "HMAC" string capitalized and followed by one space followed by the calculated hmac signature. For request generated through Server: Authorization: - HMAC . "HMAC " followed by the Encrypted payload as signature, shown below:|
|Content-Type |Yes        |application/JSON|
|Client-Token |Optional   |This is OAuth token generated by /v1/security/createsessiontoken ConnectPay API service. This would be sent in instead of Authorization by the SDK.|
|corelationID |Conditional (For merchants who opt for long lived public key)|For MAS to ConnectPayAPI server calls, MAS need to provide reference transaction id in the service request header for transaction tracking. If MAS fails to provide transaction id, then ConnectPayAPI will generate separate correlationID for each flow and each end-to-end transaction will have separate transaction id for each request in the transaction. Considering that one business scenario consists of multiple api calls, the reference transaction id of the first call should be populated in the subsequent calls.|
|isSecureCall |Conditional (For merchants who opt for long lived public key)|For MAS to ConnectPayAPI server calls, MAS need to provide the header with value ‘Y’. For SDK/App to ConnectPayAPI calls, the header is not required. If present, it should have value ‘N’ Any values other than Y/N will be treated as configuration error, and MAS will receive BAD REQUEST.|

#### Sample Header
```
"Content-Type" : "application/json"
"Api-Key" : "YMgw8VSrYMG6WTIUnoUUGv7hF9Aqh3EO"
"Timestamp": "1607368688646"
"Authorization" : "HMAC W5X9NAlPgSNsfQX55fXbXrk3arzL6KxcCTA6SrnxL+U="
"Client-Token" : "IXwY1BYpvWpoGzete43AdLzXSdj4"
```

#### How to generate HNAC Signature

##### Description
The HMAC signature is used in all calls made to our API and is necessary to receive a successful response from the system.

##### High Level Flow
- Get and save the current time in the format, UTC Timestamp, to the millisecond
- Take the API Key and append a colon along with the current time
- Save this as the current raw signature (key:time)
- Get and save the payload which is the actual body content passed as a POST request
- Encrypt the request payload using SHA256 and save it
- Take this encrypted payload, and then encrypt it using Base64.
- Take the raw signature from step 3, append a colon and the Base64 encrypted payload to it and save it
- Take the raw signature and encrypt it using HMAC SHA256 against the API Secret.
- Finally take this encrypted raw signature and append to "HMAC" followed by a space in order to create the Authorization header

##### Sample Code (Java)
```java
import java.security.MessageDigest;
import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import org.apache.commons.codec.binary.Base64;
public class HmacUtil {
    private static final String CT_CLN = ":";
    private static final String MD_ALG = "SHA-256";
    private static final String HMAC_ALG = "HmacSHA256";
    public static String generateHmac(String apiKey,
    String apiSecret,String epochTimestamp, String payload) throws Exception {
        byte[] hash = MessageDigest.getInstance(MD_ALG).digest(payload.getBytes());
        String encPyld = Base64.encodeBase64String(hash);
        String messageToSign = apiKey + CT_CLN + epochTimestamp + CT_CLN + encPyld;
        Mac hmac = Mac.getInstance(HMAC_ALG);
        SecretKeySpec key = new SecretKeySpec(apiSecret.getBytes(), HMAC_ALG);
        hmac.init(key);
        return Base64.encodeBase64String(hmac.doFinal(messageToSign.getBytes()));
    }
}
```

## How to Utilize API (Example: Add Consumer Profile)

## Step 1: Create Session Token
summary of API and reason why used first

<details>
<summary>Create Session Token</summary>
<br>
The Create Session Token API call is used to create a session token and to retrieve the RSA public encryption key generated for this session. This API is secured as it requires the Authorization header that can only be derived using the API Secret stored in the Merchant’s server. <p>

[![](button.png '')](https://qa-developer.fiserv.com/product/ConnectPay/api/?type=post&path=/security/createsessiontoken&branch=develop&version=1.0.0)
</details>

## Step 2: Utilize Encryption & Decrption Methods on Payloads
(ENDC MD Page link)
Implement Encryption & Decryption Methodologies: layout
1. AES Key Generation
2. IV Generation
3. AES Encryption
4. RSA Encryption
5. AES Decryption

## Step 3: Create & Request Payload
summary of API and reason why used first

<details>
<summary>Add Consumer Profile</summary>
<br>
The Create Consumer Profile call is mandatory for any new user enrollment. This is used to create an fdCustomerID for a provided external id (and other user information) by the merchant. The returned fdCustomerID should be used right from the enrollment use case. This API is secured, as it requires the Authorization header that can only be derived using the API Secret stored in the Merchant’s web server. <p>

[![](button.png '')](https://qa-developer.fiserv.com/product/ConnectPay/api/?type=post&path=/consumerprofile/add&branch=develop&version=1.0.0)
</details>

### Create Session Token
Use the "Create Session Token" API from Step 1 above in order to get the TokenID for the Client-Token header as well as the RSA Public Key in order to encrypt the request payload for the "Add Consumer Profile" API.

Example Request Payload:
```json
{
  "security": {
    "publicKeyRequired": true
  }
}
```

Use the payload above to create the Authorization Header.

Example Response Payload:
```json
{
    "transactionStatus": "APPROVED",
    "transactionStatusCode": 0,
    "referenceTransactionID": "bedceb8b-2445-b1d5-4c1e-c09446099023",
    "transactionStatusDescription": "OK",
    "security": {
        "tokenID": "0HMxmsoYJRfAiGdxEsjcso3K8uY6",
        "issuedOn": "1583174178590",
        "expiresInSeconds": "599",
        "publicKey": "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEArAhyMQmqTL798rKAixN9jtnp4SFF5PVpqc/HKNprSSoaANsnpJLSTRLFMCuQIa2dcgFZM+nSPvSCGowD65/tMWBHTWfeXiSV1xWmhPdEQRocmUaRp3HoEO3RU1n5os9jQLMGEcyxopgtTvUydJSrjLWNGcC9UC50HIEBEOBqycRvqlI/oRO1oBIx8UPAe/dGKTO8Bx8f6J4Lyi5ilW0gFFYSni/Krg/fMrxu6luyGmBOr2H9zy6fv+8dLQd0LEoOAaZ/2RLfcTPnheyV7eUOvOS4DGISiQBRpXyu9Zlo1B3GbiXX8NkfCo2ByDq+6gELji7Tr+gT+zuj+5H12eQIDAQAB",
        "algorithm": "RSA/None/PKCS1Padding",
        "status": "ACTIVE"
    }
}
```
Save the PublicKey as well as the tokenID as stated above

### Add Consumer Profile
Create the actual payload

Example Request Payload
```json
{
    "customer": {
        "externalID": "ConnectPay20230810003"
    }
}
```

Create the HMAC Authorization using the payload above and use the TokenID saved from earlier as the Content-Token header.

Generate the AES and IV Key and encrypt the actual payload above to create ComponentDelta.
Example Output:
```json
    "componentDelta": "7MTtHhDXZ0NTNuG4/amThFCcwOpYDd8c4JHJ6vVsyIAV3XI6iMaCaDVQAGs2BEiRePSeYaknOLTGwdQXN2T58vbnmJyDUZFssFbzSux9AKpjxPUymwcuEIHISTKEqcqOeN3leVo="
```

Encrypt the AES Key and IV in order to recieve ComponentX and ComponentY respectively:
Example Output:
```json
    "componentX": "gp2G93yK461uDV19dlQRBPvHoYDx8o5KYRT6JMvlCsWZt6AkBHUBHd31dApbSuseR369LxBcoXf7FaYNW5pSoAz/VL0Uze8to4QRLSQBdZxE7AIbldsYCyswYPunDM054H714AsLieuutMgTOJUqUbkyD2FnlBzbsgRw52i6SbeG3ioof/zWHzWsUVv1uM+M56APK48cLAVbozGjF6/rlHlMiDeU+1XjjQEAKFZTo01awfEKgI4JkqBlV7jTYiumMpMk6MolFUm/SgNFylkbvhqcnZCRTl0jpKXhEI/fHx+YYWthSP/m4IoIpewTH3Wf7M66NV7s2fLJRJq6ghfN3Q==",
    "componentY": "GYzzvhEPSurUxKBw5dVybLCMz+uPy40K6YFT1BzoqSovj24f/RemJB4VM+v+pqxmdcJKaJThPPztcRFN8rvQaE8kMbDd4hTq7yI9O7QA5FFZwYuD+C+ZmBnfBd8S81YGvbRi16bOHV/AzkaLVWGbIoPke65r4aVzo5RgT3yTPPC12JqBIQ/hS1S+vFQHBKigTWzKDCp52B250kA0XwLSr0eI/cBB0wLpKvoWjuiQJojTj49xHKG8cRBoqJlSsA70Zo+vKRHe7xL7vir+Wv9Rh5t4PILEDA3ya8+iitMsAr0wi3jWYcvdOCR7Bous+nnRjfJ5XleJAXe5dhG+l15CHg==",
```

Create a JSON Payload using the data from above:
Example Payload:
```json
{
    "componentX": "gp2G93yK461uDV19dlQRBPvHoYDx8o5KYRT6JMvlCsWZt6AkBHUBHd31dApbSuseR369LxBcoXf7FaYNW5pSoAz/VL0Uze8to4QRLSQBdZxE7AIbldsYCyswYPunDM054H714AsLieuutMgTOJUqUbkyD2FnlBzbsgRw52i6SbeG3ioof/zWHzWsUVv1uM+M56APK48cLAVbozGjF6/rlHlMiDeU+1XjjQEAKFZTo01awfEKgI4JkqBlV7jTYiumMpMk6MolFUm/SgNFylkbvhqcnZCRTl0jpKXhEI/fHx+YYWthSP/m4IoIpewTH3Wf7M66NV7s2fLJRJq6ghfN3Q==",
    "componentY": "GYzzvhEPSurUxKBw5dVybLCMz+uPy40K6YFT1BzoqSovj24f/RemJB4VM+v+pqxmdcJKaJThPPztcRFN8rvQaE8kMbDd4hTq7yI9O7QA5FFZwYuD+C+ZmBnfBd8S81YGvbRi16bOHV/AzkaLVWGbIoPke65r4aVzo5RgT3yTPPC12JqBIQ/hS1S+vFQHBKigTWzKDCp52B250kA0XwLSr0eI/cBB0wLpKvoWjuiQJojTj49xHKG8cRBoqJlSsA70Zo+vKRHe7xL7vir+Wv9Rh5t4PILEDA3ya8+iitMsAr0wi3jWYcvdOCR7Bous+nnRjfJ5XleJAXe5dhG+l15CHg==",
    "componentDelta": "7MTtHhDXZ0NTNuG4/amThFCcwOpYDd8c4JHJ6vVsyIAV3XI6iMaCaDVQAGs2BEiRePSeYaknOLTGwdQXN2T58vbnmJyDUZFssFbzSux9AKpjxPUymwcuEIHISTKEqcqOeN3leVo="
}
```

Make the call and the API will return with ComponentDelta.
Example Response Payload
```json
{
    "componentDelta": "G7ih1R80u92DZIMgDQH9Pt3yt8+cWeSeAwV5hcXuPV4DZMhv6/RNNxq4x0Zq1ICvYkho6+SQ/CEQkXmnMiUgCHIcMVEAZKZMYggJi0f8dQq1U0FhUOCQjJhlp+6+Z5CnlJUa1IpTgtuzsGLHu0nA7ysAShQ0HXKp5FnILkMUSJvYRnyAr9/i09ezn+z7PW5r2dppLTBzPHZpIAti2G0eyeJDFEpgSNme8IsUZjtgG0AqN11FKggEHGlfJFWmgSZl0T0K417TKc4mezLW30Ov4KQ8CSvXrlUWuNKdls2ehGJ/0vdJxM6BPdhdTsAoyJJub+6rCVFpZ0oSg8eYfqr7hrVwMFFJdR6K45UenSp+FCYlHM+U1hzpY+fZxdo9UqhBYU2fRXzNT1t7/nKA/e6sH8dSSxgvn78nuRcsH5mYp8Cpr7bF5vXHYFu6yxkrcgyrnpHPbrnPvDJPgtg4c6Y5vBkf64+0URhMzA1XIAMsJUZCo2jDAagHfzbzEf6Ll9ggRIflpdwFE3IVqBVShNM="
}
```

Decrypt ComponentDelta with the AES Key and IV generated earlier in order to decode the response payload into a readable form.
Example Decrypted Response Payload
```json
{
    "transactionStatus": "APPROVED",
    "transactionStatusCode": 10,
    "referenceTransactionID": "0021-8d1b02f2-fe0d-1b41-5876-7f807c1a438a",
    "transactionStatusDescription": "Previously Created",
    "responseVerbiage": "Previously Created",
    "customer": {
        "fdCustomerID": "CP5vsho3170593468563400128768J3F7x",
        "externalID": "ConnectPay20230810003"
    }
}
```

Verify that the transaction was successful.

Congratulations, you have successfully used ConnectPay's API. The steps above apply to all ConnectPay API's except for the Create Session Token API and the Get Public Key Service API as the Request Payload's do not need to be encrypted in order to use the API. The following section will go over the general flow of ConnectPay APIs in order to make a successful ACH transaction



## API Flow to process ACH transactions
This is the general flow in order to use ConnectPay's API from enrolling a consumer to processing an ACH payment transaction.

### Step 1: Create Consumer Profile
The merchant must create a consumer profile before enrolling any consumers.
<details>
<summary>Step 1: Add Consumer Profile</summary>
<br>
The Create Consumer Profile call is mandatory for any new user enrollment. This is used to create an fdCustomerID for a provided external id (and other user information) by the merchant. The returned fdCustomerID should be used right from the enrollment use case. This API is secured, as it requires the Authorization header that can only be derived using the API Secret stored in the Merchant’s web server. <p>

[![](button.png '')](https://qa-developer.fiserv.com/product/ConnectPay/api/?type=post&path=/consumerprofile/add&branch=develop&version=1.0.0)
</details>


### Step 2 Option 1: Online Bank Login
The online bank login is used when the end-user/consumer would like to login using their banking credentials in order to link their bank account to a payment method.
<details>
<summary>Step a: Establish Online Bank Login</summary>
<br>
Use this as the first step in online bank login process. The output from this service needs to be passed to online bank login processor to initiate the bank login IFRAME.<p>

[![](button.png '')](https://qa-developer.fiserv.com/product/ConnectPay/api/?type=post&path=/onlinebanklogin/establish&branch=develop&version=1.0.0)
</details>

<details>
<summary>Step b: Validate Online Bank Login</summary>
<br>
Use this method to after consumer has completed bank selection process, to pull all consumer information available on bank records to be displayed on consumer’s screen Consumer can view and edit the enrollment form prepopulated with the data from above step. Bank information is the only set of fields which should be not editable. <p>

[![](button.png '')](https://qa-developer.fiserv.com/product/ConnectPay/api/?type=post&path=/onlinebanklogin/validate&branch=develop&version=1.0.0)
</details>
<details>
<summary>Step c: Consumer Enrollment</summary>
<br>
The Consumer Enrollment call is for any new consumer enrollment purpose. This is used to perform a ConnectPay enrollment process for a provided consumer details payload. This API is secured, as it requires the Authorization header that can only be derived using the API Secret stored in the Merchant’s web server. <p>

[![](button.png '')](https://qa-developer.fiserv.com/product/ConnectPay/api/?type=post&path=/consumerprofile/enrollment&branch=develop&version=1.0.0)
</details>


### Step 2 Option 2: Manual Enrollment
The manual enrollment is used when the end-user/consumer does not want to login with their bank credentials and would rather deposit smaller amounts using information such as the bank routing and account number.
<details>
<summary>Step a: Consumer Enrollment</summary>
<br>
The Consumer Enrollment call is for any new consumer enrollment purpose. This is used to perform a ConnectPay enrollment process for a provided consumer details payload. This API is secured, as it requires the Authorization header that can only be derived using the API Secret stored in the Merchant’s web server. <p>

[![](button.png '')](https://qa-developer.fiserv.com/product/ConnectPay/api/?type=post&path=/consumerprofile/enrollment&branch=develop&version=1.0.0)
</details>

<details>
<summary>Step b: Micro-Deposit Validation</summary>
<br>
Use this method to complete micro deposit validation to authenticate your bank account after a manual enrollment.ConnectPayAPI Direct Integration Guide. Kindly note it might take a few days for the micro deposits to appear on your bank account. Once bank account is successfully authenticated, the ACH payment option gets activated for transaction. For MAS to ConnectPayAPI Server call, MAS needs to pass the fdAccountID in payload request. <p>

[![](button.png '')]()
</details>


### Step 3: ACH Transactions
These APIs are for the merchant to implement depending on the use case of the end-user/consumer.
<details>
<summary>Purchase</summary>
<br>
Merchants who want to process ACH Transactions through FirstAPI must make server-to-server calls and pass necessary encrypted payload as required for that particular case. Use this to initiate purchase/sale transaction request where final amount is known. <p>

[![](button.png '')](https://qa-developer.fiserv.com/product/ConnectPay/api/?type=post&path=/transaction/purchase&branch=develop&version=1.0.0)
</details>

<details>
<summary>Authorize</summary>
<br>
Merchants who want to process ACH Transactions through FirstAPI must make server-to-server calls and pass necessary encrypted payload as required for that particular case. Use this to initiate purchase/sale transaction request where final amount is known. <p>

[![](button.png '')](https://qa-developer.fiserv.com/product/ConnectPay/api/?type=post&path=/transaction/authorize&branch=develop&version=1.0.0)
</details>


### Other APIs:


### Useful Artifacts to help you Integrate
[//]: <> (Need to link below to the actual files)
- [Implementation*Guide](../documentation/implementationguide.md)
- [SDK](../assets/connect-pay_spec.zip)
